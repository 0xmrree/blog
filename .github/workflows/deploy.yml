name: Deploy to IPFS via Pinata

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build single HTML file
        run: npm run build
      
      - name: Install Pinata SDK
        run: npm install pinata-web3
      
      - name: Upload to IPFS via Pinata
        id: pinata
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWS }}
        run: |
          cat > upload.mjs << 'EOF'
          import { PinataSDK } from "pinata-web3";
          import fs from "fs";
          
          const pinata = new PinataSDK({
            pinataJwt: process.env.PINATA_JWT,
            pinataGateway: "gateway.pinata.cloud"
          });
          
          async function main() {
            try {
              // Read the built HTML file
              const fileBuffer = fs.readFileSync("./dist/index.html");
              const file = new File([fileBuffer], "index.html", { type: "text/html" });
              
              // Upload to Pinata
              const upload = await pinata.upload.file(file);
              console.log("Upload successful!");
              console.log("CID:", upload.IpfsHash);
              
              // Save CID to file for next step
              fs.writeFileSync("cid.txt", upload.IpfsHash);
            } catch (error) {
              console.error("Upload failed:", error);
              process.exit(1);
            }
          }
          
          await main();
          EOF
          
          node upload.mjs
          CID=$(cat cid.txt)
          echo "hash=$CID" >> $GITHUB_OUTPUT
          
      - name: Show Deployment Info
        run: |
          echo "ðŸŽ‰ Deployed to IPFS!"
          echo "CID: ${{ steps.pinata.outputs.hash }}"
          echo "View at: https://gateway.pinata.cloud/ipfs/${{ steps.pinata.outputs.hash }}"
          echo "Or: ipfs://${{ steps.pinata.outputs.hash }}"
