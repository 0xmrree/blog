name: Deploy to IPFS via Pinata

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Install Pinata SDK locally
        run: npm install pinata-web3
      
      - name: Upload to Pinata using SDK
        id: pinata
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          # Create a Node script to upload
          cat > upload.mjs << 'EOF'
          import { PinataSDK } from "pinata-web3";
          import fs from "fs";

          const pinata = new PinataSDK({
            pinataJwt: process.env.PINATA_JWT
          });

          async function upload() {
            const upload = await pinata.upload.directory("./build");
            console.log("Upload result:", upload);
            fs.writeFileSync("cid.txt", upload.IpfsHash);
          }

          upload().catch(console.error);
          EOF
          
          node upload.mjs
          CID=$(cat cid.txt)
          echo "hash=$CID" >> $GITHUB_OUTPUT
          echo "Uploaded with CID: $CID"
          
      - name: Show Deployment Info
        run: |
          echo "ðŸŽ‰ Deployed to IPFS!"
          echo "CID: ${{ steps.pinata.outputs.hash }}"
          echo "View at: https://gateway.pinata.cloud/ipfs/${{ steps.pinata.outputs.hash }}"
          echo "Or: ipfs://${{ steps.pinata.outputs.hash }}"